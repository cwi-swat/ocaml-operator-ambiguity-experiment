toplevels 
(
    
        									 
     let
     (
      
       debug
       false 
      							    		    
     )
        									 
        									 
    
        									 
     open Printf
        									 
        									 
    
        									 
     module  Hashed
      struct
      (
      							  
      type
      (  						
          							    	 
         t
         type
         params=
         (
         
         )
         cstrs =
         (
         )
         kind =
         
          list
          (
            
            string
            (
            )
            								  
          )
          
             									
         
         														  
         														 
        											   
      								        
      )
      							  
      let
      (
       
        equal
       (
        case
            (
         		
         		 x
         		(
         		 case
         		     (
         		 	  y
         		      
         		      sequence
         		      (
         		        eprintf
         		        (
         		            "equal: %s / %s\n"
         		            List.hd
         		            (
         		                x
         		            )
         		            List.hd
         		            (
         		                y
         		            )
         		        )
         		      ;
         		        =
         		        (
         		            x
         		            y
         		        )
         		      )
         		          							
         		     )
         		)
         		    		   
            )
       )
           		    
      )
      							  
      let
      (
       
        hash
       (
        case
            (
        	  x
             Hashtbl.hash
             (
                 List.hd
                 (
                     x
                 )
             )
            )
       )
           		    
      )
      							  
      )
      							  
     										    
        									 
        									 
    
        									 
     module  HT
      
          								  
       Weak.Make
          							     
      (
      Hashed
      )
      								   
     										    
        									 
        									 
    
        									 
     let
     (
      
       tbl
       HT.create
       (
           7
       ) 
      							    		    
     )
        									 
        									 
    
        									 
     let
     (
      
       r
       ref
       (
           []
       ) 
      							    		    
     )
        									 
        									 
    
        									 
     let
     (
      
       bunch
       ifthenelse
       (
        if
        (
         <
         (
             Array.length
             (
                 Sys.argv
             )
             2
         )
        )
        then
        (
         10000
        )
        else
        (
         int_of_string
         (
             Array.get
             (
              Sys.argv
              1
             )
                 													
         )
        ) 
       )
       	    											  
      							    		    
     )
        									 
        									 
    Random.init
    (
        314
    )
    
        									 
     let
     (
      
       random_string
      (
       case
           (
       	  n
            
            let
            (
             (
                									  
              
               result
               String.create
               (
                   n
               ) 
              							    		   
                									  
             )
            in
              
              sequence
              (
                forloop 
                (
                    i
                    0
                    <>
                    -
                    (
                        n
                        1
                    )
                    semicolon 
                    (
                        Array.set
                        (
                         result
                         i
                         Char.chr
                         (
                             +
                             (
                                 32
                                 Random.int
                                 (
                                     95
                                 )
                             )
                         )
                        )
                            									
                    )
                )
              ;
                result
              )
                  							
            )
                									
           )
      )
          		    
     )
        									 
        									 
    
        									 
     let
     (
      
       added
       ref
       (
           0
       ) 
      							    		    
     )
        									 
        									 
    
        									 
     let
     (
      
       mistakes
       ref
       (
           0
       ) 
      							    		    
     )
        									 
        									 
    
        									 
     let
     (
      
       print_status
      (
       case
           (
       	  ()
            
            let
            (
             (
                									  
              
               
               (
                len
                    						 
               	entries
               
               	sumbuck
               
               	buckmin
               
               	buckmed
               
               	buckmax
               
               )
               HT.stats
               (
                   tbl
               ) 
              							    		   
                									  
             )
            in
              
              sequence
              (
                ifthenelse
                (
                 if
                 (
                  >
                  (
                      entries
                      *
                      (
                          bunch
                          +
                          (
                              
                               !
                               (
                               added
                               )
                                  							 
                              1
                          )
                      )
                  )
                 )
                 then
                 (
                  beginEnd 
                  (
                      
                      sequence
                      (
                        ifthenelse
                        (
                         if
                         (
                          debug
                         )
                         then
                         (
                          beginEnd 
                          (
                              
                              sequence
                              (
                                printf
                                (
                                    "\n===================\n"
                                )
                              ;
                                
                                sequence
                                (
                                  printf
                                  (
                                      "len = %d\n"
                                      len
                                  )
                                ;
                                  
                                  sequence
                                  (
                                    printf
                                    (
                                        "entries = %d\n"
                                        entries
                                    )
                                  ;
                                    
                                    sequence
                                    (
                                      printf
                                      (
                                          "sum of bucket sizes = %d\n"
                                          sumbuck
                                      )
                                    ;
                                      
                                      sequence
                                      (
                                        printf
                                        (
                                            "min bucket = %d\n"
                                            buckmin
                                        )
                                      ;
                                        
                                        sequence
                                        (
                                          printf
                                          (
                                              "med bucket = %d\n"
                                              buckmed
                                          )
                                        ;
                                          
                                          sequence
                                          (
                                            printf
                                            (
                                                "max bucket = %d\n"
                                                buckmax
                                            )
                                          ;
                                            
                                            sequence
                                            (
                                              printf
                                              (
                                                  "GC count = %d\n"
                                                  field
                                                  (
                                                  Gc.quick_stat
                                                  (
                                                      ()
                                                  )
                                                  path_field_name 
                                                  (
                                                      Gc
                                                      major_collections
                                                  )
                                                  )
                                                      									 
                                              )
                                            ;
                                              semicolon 
                                              (
                                                  flush
                                                  (
                                                      stdout
                                                  )
                                              )
                                            )
                                                							
                                          )
                                              							
                                        )
                                            							
                                      )
                                          							
                                    )
                                        							
                                  )
                                      							
                                )
                                    							
                              )
                                  							
                          )
                         )
                         else
                         (
                         )
                        )
                            									   
                      ;
                        semicolon 
                        (
                            incr
                            (
                                mistakes
                            )
                        )
                      )
                          							
                  )
                 )
                 else
                 (
                 )
                )
                    									   
              ;
                semicolon 
                (
                    :=
                    (
                        added
                        0
                    )
                )
              )
                  							
            )
                									
           )
      )
          		    
     )
        									 
        									 
    Gc.create_alarm
    (
        print_status
    )
    forloop 
    (
        j
        0
        <>
        99
        
        sequence
        (
          :=
          (
              r
              []
          )
        ;
          
          sequence
          (
            incr
            (
                added
            )
          ;
            semicolon 
            (
                forloop 
                (
                    i
                    1
                    <>
                    bunch
                    
                    let
                    (
                     (
                        									  
                      
                       c
                       random_string
                       (
                           7
                       ) 
                      							    		   
                        									  
                     )
                    in
                      
                      sequence
                      (
                        :=
                        (
                            r
                            ::
                            (
                                c
                                
                                 !
                                 (
                                 r
                                 )
                                    							 
                            )
                        )
                      ;
                        semicolon 
                        (
                            HT.add
                            (
                                tbl
                                
                                 !
                                 (
                                 r
                                 )
                                    							 
                            )
                        )
                      )
                          							
                    )
                        									
                )
            )
          )
              							
        )
            							
    )
    ifthenelse
    (
     if
     (
      <
      (
          
           !
           (
           mistakes
           )
              							 
          5
      )
     )
     then
     (
      printf
      (
          "pass\n"
      )
     )
     else
     (
      printf
      (
          "fail\n"
      )
     ) 
    )
    	    											 
    
)