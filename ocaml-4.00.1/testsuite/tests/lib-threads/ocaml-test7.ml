(
  open Event
  let
  (
    add_ch
      new_channel
      (
          ()
                )
  )
  let
  (
    sub_ch
      new_channel
      (
          ()
                )
  )
  let
  (
    read_ch
      new_channel
      (
          ()
                )
  )
  let
  (
    accu
      (
        case
        (
          n
          select
          (
              ::
                (
                  wrap
                  (
                      receive
                      (
                          add_ch
                      )
                      (
                        case
                        (
                          x
                          accu
                          (
                              +
                              (
                                  n
                                  x
                              )
                          )
                        )
                      )
                  )
                  ::
                    (
                      wrap
                      (
                          receive
                          (
                              sub_ch
                          )
                          (
                            case
                            (
                              x
                              accu
                              (
                                  -
                                  (
                                      n
                                      x
                                  )
                              )
                            )
                          )
                      )
                      ::
                        (
                          wrap
                          (
                              send
                              (
                                  read_ch
                                  n
                              )
                              (
                                case
                                (
                                  ()
                                                                    accu
                                  (
                                      n
                                  )
                                )
                              )
                          )
                          []
                                                  )
                    )
                )
          )
        )
      )
  )
  let
  (
    sender
      (
        case
        (
          chan
          (
            case
            (
              value
              sequence
              (
                sync
                (
                    send
                    (
                        chan
                        value
                    )
                )
              ;
                sender
                (
                    chan
                    value
                )
              )
            )
          )
        )
      )
  )
  let
  (
    read
      (
        case
        (
          ()
                    sequence
          (
            print_int
            (
                sync
                (
                    receive
                    (
                        read_ch
                    )
                )
            )
          ;
            print_newline
            (
                ()
                            )
          )
        )
      )
  )
  let
  (
    main
      (
        case
        (
          ()
                    sequence
          (
            Thread.create
            (
                accu
                0
            )
          ;
            sequence
            (
              Thread.create
              (
                  sender
                  (
                      add_ch
                  )
                  1
              )
            ;
              sequence
              (
                Thread.create
                (
                    sender
                    (
                        sub_ch
                    )
                    1
                )
              ;
                while
                true
                                read
                (
                    ()
                                    )
              )
            )
          )
        )
      )
  )
  Printexc.catch
  (
      main
      ()
        )
)

