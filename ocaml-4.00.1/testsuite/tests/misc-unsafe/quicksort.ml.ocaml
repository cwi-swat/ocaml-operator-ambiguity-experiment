(
  let
  (
    qsort
      (
        case
        (
          lo
          (
            case
            (
              hi
              (
                case
                (
                  a
                     array
                    (
                         int
                        (
                        )
                    )
                  ifthenelse
                  (
                    if
                    (
                      <
                      (
                        
                          lo
                        
                          hi
                      )
                    )
                    then
                    (
                      let
                      (
                        (
                          i
                            ref
                            (
                              
                                lo
                            )
                        )
                      in
                        let
                        (
                          (
                            j
                              ref
                              (
                                
                                  hi
                              )
                          )
                        in
                          let
                          (
                            (
                              pivot
                                Array.get
                                (
                                  
                                    a
                                  
                                    hi
                                )
                            )
                          in
                            sequence
                            (
                              while
                              <
                              (
                                
                                  !
                                  (
                                    
                                      i
                                  )
                                
                                  !
                                  (
                                    
                                      j
                                  )
                              )
                              sequence
                              (
                                while
                                &&
                                (
                                  
                                    <
                                    (
                                      
                                        !
                                        (
                                          
                                            i
                                        )
                                      
                                        hi
                                    )
                                  
                                    <=
                                    (
                                      
                                        Array.get
                                        (
                                          
                                            a
                                          
                                            !
                                            (
                                              
                                                i
                                            )
                                        )
                                      
                                        pivot
                                    )
                                )
                                incr
                                (
                                  
                                    i
                                )
                              ;
                                sequence
                                (
                                  while
                                  &&
                                  (
                                    
                                      >
                                      (
                                        
                                          !
                                          (
                                            
                                              j
                                          )
                                        
                                          lo
                                      )
                                    
                                      >=
                                      (
                                        
                                          Array.get
                                          (
                                            
                                              a
                                            
                                              !
                                              (
                                                
                                                  j
                                              )
                                          )
                                        
                                          pivot
                                      )
                                  )
                                  decr
                                  (
                                    
                                      j
                                  )
                                ;
                                  ifthenelse
                                  (
                                    if
                                    (
                                      <
                                      (
                                        
                                          !
                                          (
                                            
                                              i
                                          )
                                        
                                          !
                                          (
                                            
                                              j
                                          )
                                      )
                                    )
                                    then
                                    (
                                      let
                                      (
                                        (
                                          temp
                                            Array.get
                                            (
                                              
                                                a
                                              
                                                !
                                                (
                                                  
                                                    i
                                                )
                                            )
                                        )
                                      in
                                        sequence
                                        (
                                          Array.set
                                          (
                                            
                                              a
                                            
                                              !
                                              (
                                                
                                                  i
                                              )
                                            
                                              Array.get
                                              (
                                                
                                                  a
                                                
                                                  !
                                                  (
                                                    
                                                      j
                                                  )
                                              )
                                          )
                                        ;
                                          Array.set
                                          (
                                            
                                              a
                                            
                                              !
                                              (
                                                
                                                  j
                                              )
                                            
                                              temp
                                          )
                                        )
                                      )
                                    )
                                    else
                                    (
                                                                          )
                                  )
                                )
                              )
                            ;
                              let
                              (
                                (
                                  temp
                                    Array.get
                                    (
                                      
                                        a
                                      
                                        !
                                        (
                                          
                                            i
                                        )
                                    )
                                )
                              in
                                sequence
                                (
                                  Array.set
                                  (
                                    
                                      a
                                    
                                      !
                                      (
                                        
                                          i
                                      )
                                    
                                      Array.get
                                      (
                                        
                                          a
                                        
                                          hi
                                      )
                                  )
                                ;
                                  sequence
                                  (
                                    Array.set
                                    (
                                      
                                        a
                                      
                                        hi
                                      
                                        temp
                                    )
                                  ;
                                    sequence
                                    (
                                      qsort
                                      (
                                        
                                          lo
                                        
                                          -
                                          (
                                            
                                              !
                                              (
                                                
                                                  i
                                              )
                                            
                                              1
                                          )
                                        
                                          a
                                      )
                                    ;
                                      qsort
                                      (
                                        
                                          +
                                          (
                                            
                                              !
                                              (
                                                
                                                  i
                                              )
                                            
                                              1
                                          )
                                        
                                          hi
                                        
                                          a
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                    else
                    (
                                          )
                  )
                )
              )
            )
          )
        )
      )
  )
  let
  (
    cmp
      (
        case
        (
          i
          (
            case
            (
              j
              -
              (
                
                  i
                
                  j
              )
            )
          )
        )
      )
  )
  let
  (
    qsort2
      (
        case
        (
          lo
          (
            case
            (
              hi
              (
                case
                (
                  a
                     array
                    (
                         int
                        (
                        )
                    )
                  ifthenelse
                  (
                    if
                    (
                      <
                      (
                        
                          lo
                        
                          hi
                      )
                    )
                    then
                    (
                      let
                      (
                        (
                          i
                            ref
                            (
                              
                                lo
                            )
                        )
                      in
                        let
                        (
                          (
                            j
                              ref
                              (
                                
                                  hi
                              )
                          )
                        in
                          let
                          (
                            (
                              pivot
                                Array.get
                                (
                                  
                                    a
                                  
                                    hi
                                )
                            )
                          in
                            sequence
                            (
                              while
                              <
                              (
                                
                                  !
                                  (
                                    
                                      i
                                  )
                                
                                  !
                                  (
                                    
                                      j
                                  )
                              )
                              sequence
                              (
                                while
                                &&
                                (
                                  
                                    <
                                    (
                                      
                                        !
                                        (
                                          
                                            i
                                        )
                                      
                                        hi
                                    )
                                  
                                    <=
                                    (
                                      
                                        cmp
                                        (
                                          
                                            Array.get
                                            (
                                              
                                                a
                                              
                                                !
                                                (
                                                  
                                                    i
                                                )
                                            )
                                          
                                            pivot
                                        )
                                      
                                        0
                                    )
                                )
                                incr
                                (
                                  
                                    i
                                )
                              ;
                                sequence
                                (
                                  while
                                  &&
                                  (
                                    
                                      >
                                      (
                                        
                                          !
                                          (
                                            
                                              j
                                          )
                                        
                                          lo
                                      )
                                    
                                      >=
                                      (
                                        
                                          cmp
                                          (
                                            
                                              Array.get
                                              (
                                                
                                                  a
                                                
                                                  !
                                                  (
                                                    
                                                      j
                                                  )
                                              )
                                            
                                              pivot
                                          )
                                        
                                          0
                                      )
                                  )
                                  decr
                                  (
                                    
                                      j
                                  )
                                ;
                                  ifthenelse
                                  (
                                    if
                                    (
                                      <
                                      (
                                        
                                          !
                                          (
                                            
                                              i
                                          )
                                        
                                          !
                                          (
                                            
                                              j
                                          )
                                      )
                                    )
                                    then
                                    (
                                      let
                                      (
                                        (
                                          temp
                                            Array.get
                                            (
                                              
                                                a
                                              
                                                !
                                                (
                                                  
                                                    i
                                                )
                                            )
                                        )
                                      in
                                        sequence
                                        (
                                          Array.set
                                          (
                                            
                                              a
                                            
                                              !
                                              (
                                                
                                                  i
                                              )
                                            
                                              Array.get
                                              (
                                                
                                                  a
                                                
                                                  !
                                                  (
                                                    
                                                      j
                                                  )
                                              )
                                          )
                                        ;
                                          Array.set
                                          (
                                            
                                              a
                                            
                                              !
                                              (
                                                
                                                  j
                                              )
                                            
                                              temp
                                          )
                                        )
                                      )
                                    )
                                    else
                                    (
                                                                          )
                                  )
                                )
                              )
                            ;
                              let
                              (
                                (
                                  temp
                                    Array.get
                                    (
                                      
                                        a
                                      
                                        !
                                        (
                                          
                                            i
                                        )
                                    )
                                )
                              in
                                sequence
                                (
                                  Array.set
                                  (
                                    
                                      a
                                    
                                      !
                                      (
                                        
                                          i
                                      )
                                    
                                      Array.get
                                      (
                                        
                                          a
                                        
                                          hi
                                      )
                                  )
                                ;
                                  sequence
                                  (
                                    Array.set
                                    (
                                      
                                        a
                                      
                                        hi
                                      
                                        temp
                                    )
                                  ;
                                    sequence
                                    (
                                      qsort2
                                      (
                                        
                                          lo
                                        
                                          -
                                          (
                                            
                                              !
                                              (
                                                
                                                  i
                                              )
                                            
                                              1
                                          )
                                        
                                          a
                                      )
                                    ;
                                      qsort2
                                      (
                                        
                                          +
                                          (
                                            
                                              !
                                              (
                                                
                                                  i
                                              )
                                            
                                              1
                                          )
                                        
                                          hi
                                        
                                          a
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                    else
                    (
                                          )
                  )
                )
              )
            )
          )
        )
      )
  )
  let
  (
    seed
      ref
      (
        
          0
      )
  )
  let
  (
    random
      (
        case
        (
          ()
                    sequence
          (
            :=
            (
              
                seed
              
                +
                (
                  
                    *
                    (
                      
                        !
                        (
                          
                            seed
                        )
                      
                        25173
                    )
                  
                    17431
                )
            )
          ;
            land
            (
              
                !
                (
                  
                    seed
                )
              
                4095
            )
          )
        )
      )
  )
  exception Failed
  (
  )
  let
  (
    test_sort
      (
        case
        (
          sort_fun
          (
            case
            (
              size
              let
              (
                (
                  a
                    Array.create
                    (
                      
                        size
                      
                        0
                    )
                )
              in
                let
                (
                  (
                    check
                      Array.create
                      (
                        
                          4096
                        
                          0
                      )
                  )
                in
                  sequence
                  (
                    for i
                    0
                    -
                    (
                      
                        size
                      
                        1
                    )
                    let
                    (
                      (
                        n
                          random
                          (
                            
                              ()
                                                        )
                      )
                    in
                      sequence
                      (
                        Array.set
                        (
                          
                            a
                          
                            i
                          
                            n
                        )
                      ;
                        Array.set
                        (
                          
                            check
                          
                            n
                          
                            +
                            (
                              
                                Array.get
                                (
                                  
                                    check
                                  
                                    n
                                )
                              
                                1
                            )
                        )
                      )
                    )
                  ;
                    sequence
                    (
                      sort_fun
                      (
                        
                          0
                        
                          -
                          (
                            
                              size
                            
                              1
                          )
                        
                          a
                      )
                    ;
                      try
                      sequence
                      (
                        Array.set
                        (
                          
                            check
                          
                            Array.get
                            (
                              
                                a
                              
                                0
                            )
                          
                            -
                            (
                              
                                Array.get
                                (
                                  
                                    check
                                  
                                    Array.get
                                    (
                                      
                                        a
                                      
                                        0
                                    )
                                )
                              
                                1
                            )
                        )
                      ;
                        sequence
                        (
                          for i
                          1
                          -
                          (
                            
                              size
                            
                              1
                          )
                          sequence
                          (
                            ifthenelse
                            (
                              if
                              (
                                >
                                (
                                  
                                    Array.get
                                    (
                                      
                                        a
                                      
                                        -
                                        (
                                          
                                            i
                                          
                                            1
                                        )
                                    )
                                  
                                    Array.get
                                    (
                                      
                                        a
                                      
                                        i
                                    )
                                )
                              )
                              then
                              (
                                raise
                                (
                                  
                                    Failed
                                                                    )
                              )
                              else
                              (
                                                              )
                            )
                          ;
                            Array.set
                            (
                              
                                check
                              
                                Array.get
                                (
                                  
                                    a
                                  
                                    i
                                )
                              
                                -
                                (
                                  
                                    Array.get
                                    (
                                      
                                        check
                                      
                                        Array.get
                                        (
                                          
                                            a
                                          
                                            i
                                        )
                                    )
                                  
                                    1
                                )
                            )
                          )
                        ;
                          sequence
                          (
                            for i
                            0
                            4095
                            ifthenelse
                            (
                              if
                              (
                                <>
                                (
                                  
                                    Array.get
                                    (
                                      
                                        check
                                      
                                        i
                                    )
                                  
                                    0
                                )
                              )
                              then
                              (
                                raise
                                (
                                  
                                    Failed
                                                                    )
                              )
                              else
                              (
                                                              )
                            )
                          ;
                            sequence
                            (
                              print_string
                              (
                                
                                  "OK"
                              )
                            ;
                              print_newline
                              (
                                
                                  ()
                                                                )
                            )
                          )
                        )
                      )
                      (
                        case
                        (
                          Failed
                                                    sequence
                          (
                            print_string
                            (
                              
                                "failed"
                            )
                          ;
                            print_newline
                            (
                              
                                ()
                                                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
  )
  let
  (
    main
      (
        case
        (
          ()
                    sequence
          (
            test_sort
            (
              
                qsort
              
                500000
            )
          ;
            test_sort
            (
              
                qsort2
              
                500000
            )
          )
        )
      )
  )
  sequence
  (
    main
    (
      
        ()
            )
  ;
    exit
    (
      
        0
    )
  )
)

